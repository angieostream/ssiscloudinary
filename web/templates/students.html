{% extends "Index.html" %}

{% block title %}Students{% endblock %}

{% block content %}
<div class="row">
    <div class="col-sm-1"></div>
    <div class="col-sm-10">
        <h2>
            Student List 
            <button class="btn btn-primary float-right" data-toggle="modal" data-target="#addStudentModal">Add Student</button>
        </h2>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            <div class="container">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <button type="button" class="close" data-dismiss="alert" aria-label="close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
        <!-- Student Table -->
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">No.</th>
                    <th scope="col">Profile</th> <!-- Photo column before ID -->
                    <th scope="col">ID</th>
                    <th scope="col">First Name</th>
                    <th scope="col">Last Name</th>
                    <th scope="col">Course</th>
                    <th scope="col">Year</th>
                    <th scope="col">Gender</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if student %}
                    {% for row in student %}
                    <tr>
                        <td>{{ (current_page - 1) * per_page + loop.index }}</td>
                        <td>
                            {% if row[0] %}
                                <img id="student-image-{{ row[1] }}" src="{{ row[0] }}" alt="Student Image" class="profile-img">
                            {% else %}
                                <div class="profile-img no-photo">N/A</div>
                            {% endif %}
                        </td>                                               
                        <td>{{ row[1] }}</td> 
                        <td>{{ row[2] }}</td> 
                        <td>{{ row[3] }}</td> 
                        <td>
                        {{ row[4] or '' }}
                        {% if row[7] %}
                            ({{ row[7] }})
                        {% endif %}
                        </td>
 
                        <td>{{ row[5] }}</td> 
                        <td>{{ row[6] }}</td> 
                        <td>
                            <button class="btn btn-warning btn-sm" data-toggle="modal" data-target="#editStudentModal" 
                            data-id="{{ row[1] }}" 
                            data-firstname="{{ row[2] }}" 
                            data-lastname="{{ row[3] }}" 
                            data-course="{{ row[4] }}" 
                            data-year="{{ row[5] }}" 
                            data-gender="{{ row[6] }}" 
                            data-image="{{ row[0] }}">Edit</button> 
                        
                            <a href="/delete/{{ row[1] }}" onclick="return confirm('Are You Sure You Want to Delete Student?')" class="btn btn-danger btn-sm">Delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
            
        </table>

        <ul class="pagination justify-content-center">
            <!-- Previous Page Arrow -->
            <li class="page-item {% if current_page|default(1) == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('views.search', query=search_query, search_type=request.args.get('search_type'), page=current_page|default(1) - 1) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
        
            <!-- First Page and Dots -->
            {% if current_page|default(1) > 2 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('views.search', query=search_query, search_type=request.args.get('search_type'), page=1) }}">1</a>
                </li>
                {% if current_page|default(1) > 3 %}
                    <li class="page-item disabled"><a class="page-link">...</a></li>
                {% endif %}
            {% endif %}
        
            <!-- Page Numbers -->
            {% set start_page = 1 if current_page|default(1) - 1 < 1 else current_page|default(1) - 1 %}
            {% set end_page = total_pages|default(1) if current_page|default(1) + 1 > total_pages|default(1) else current_page|default(1) + 1 %}
            {% for page_num in range(start_page, end_page + 1) %}
                <li class="page-item {% if page_num == current_page|default(1) %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('views.search', query=search_query, search_type=request.args.get('search_type'), page=page_num) }}">{{ page_num }}</a>
                </li>
            {% endfor %}
        
            <!-- Last Page and Dots -->
            {% if current_page|default(1) < total_pages|default(1) - 1 %}
                {% if current_page|default(1) < total_pages|default(1) - 2 %}
                    <li class="page-item disabled"><a class="page-link">...</a></li>
                {% endif %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('views.search', query=search_query, search_type=request.args.get('search_type'), page=total_pages|default(1)) }}">{{ total_pages|default(1) }}</a>
                </li>
            {% endif %}
        
            <!-- Next Page Arrow -->
            <li class="page-item {% if current_page|default(1) == total_pages|default(1) %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('views.search', query=search_query, search_type=request.args.get('search_type'), page=current_page|default(1) + 1) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
               
        
    </div>
</div>

<!-- Add Student Modal -->
<div id="addStudentModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add New Student</h4>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('views.students') }}" method="POST" id="addStudentForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Upload Image:</label><br>
                        <button type="button" id="upload_widget_opener" class="btn btn-primary">Upload Photo</button>
                        <!-- Hidden input to store the uploaded image URL -->
                        <input type="hidden" name="image_url" id="image_url" />
                        <!-- Optionally show preview -->
                        <div id="preview_container" style="margin-top:10px;">
                            <img id="preview_image" src="" alt="No image uploaded" style="max-width: 150px; display:none;" />
                        </div>
                    </div>
                                        
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" name="id" class="form-control" required
                        pattern="^\d{4}-\d{4}$" 
                        placeholder="0000-0000">
                    </div>
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" name="firstname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="lastname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Course Code</label>
                        <select name="course" class="form-control" required>
                            <option value="">Select Course</option>
                            {% for program in programs %}
                                <option value="{{ program[0] }}">{{ program[0] }} - {{ program[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year</label>
                        <select name="year" class="form-control" required>
                            <option value="">Select Year</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select name="gender" class="form-control" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" form="addStudentForm" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Student Modal -->
<div id="editStudentModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Edit Student</h4>
            </div>
            <div class="modal-body">
                <form id="editStudentForm" method="POST" action="{{ url_for('views.update') }}" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" name="id" class="form-control" id="editId" readonly>
                    </div>
                    <div class="form-group">
                        <label>Photo</label><br>
                        <button type="button" id="upload_widget_opener_edit" class="btn btn-primary">Upload Photo</button>
                        <input type="hidden" name="image_url" id="edit_image_url" />
                        <input type="hidden" name="current_image_url" id="currentImageUrl" />

                        <br>
                        <img id="editStudentImage" src="" alt="Current Image" class="profile-img" style="max-width: 200px; display: none; margin-top:10px;">
                    </div>

                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" name="firstname" class="form-control" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="lastname" class="form-control" id="editLastName" required>
                    </div>
                    <div class="form-group">
                        <label>Course Code</label>
                        <select name="course" class="form-control" id="editCourse" required>
                            <option value="">Select Course</option>
                            {% for program in programs %}
                                <option value="{{ program[0] }}">{{ program[0] }} - {{ program[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year</label>
                        <select name="year" class="form-control" id="editYear" required>
                            <option value="">Select Year</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select name="gender" class="form-control" id="editGender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" form="editStudentForm" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>




<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>


<script>
$('#editStudentModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget); 
    var id = button.data('id');
    var firstname = button.data('firstname');
    var lastname = button.data('lastname');
    var course = button.data('course');
    var year = button.data('year');
    var gender = button.data('gender');
    var imageUrl = button.data('image'); 

    // Update the modal's content
    var modal = $(this);
    modal.find('#editId').val(id);
    modal.find('#editFirstName').val(firstname);
    modal.find('#editLastName').val(lastname);
    modal.find('#editCourse').val(course);
    modal.find('#editYear').val(year);
    modal.find('#editGender').val(gender);

    // Update the image
    if (imageUrl) {
        modal.find('#editStudentImage').attr('src', imageUrl).show(); 
        modal.find('#currentImageUrl').val(imageUrl); 
    } else {
        modal.find('#editStudentImage').hide(); 
    }
});

    function toggleStudentTable() {
        var studentTable = document.getElementById("studentTable");
        if (studentTable.style.display === "none") {
            studentTable.style.display = "block"; 
        } else {
            studentTable.style.display = "none"; 
        }
    }
</script>
<script>
  var myWidget = cloudinary.createUploadWidget({
    cloudName: 'dygsi9hr5', // replace this with your actual cloud name
    uploadPreset: 'ml_default', // your unsigned preset from Cloudinary dashboard
    multiple: false,
    maxFileSize: 2 * 1024 * 1024, // 2MB
    clientAllowedFormats: ["png", "jpg", "jpeg"],
  }, (error, result) => {
    if (!error && result && result.event === "success") {
      console.log('Upload successful: ', result.info);
      // Store the secure_url in hidden input
      document.getElementById('image_url').value = result.info.secure_url;
      // Show preview
      var preview = document.getElementById('preview_image');
      preview.src = result.info.secure_url;
      preview.style.display = 'block';
    }
  });

  document.getElementById("upload_widget_opener").addEventListener("click", function(){
    myWidget.open();
  }, false);

  var myWidgetEdit = cloudinary.createUploadWidget({
    cloudName: 'dygsi9hr5', // replace this
    uploadPreset: 'ml_default', // replace this
    multiple: false,
    maxFileSize: 2 * 1024 * 1024, // 2MB
    clientAllowedFormats: ["png", "jpg", "jpeg"],
}, (error, result) => {
    if (!error && result && result.event === "success") {
        console.log('Edit upload successful:', result.info);
        // Set hidden input value
        document.getElementById('edit_image_url').value = result.info.secure_url;
        // Show preview image and update src
        var preview = document.getElementById('editStudentImage');
        preview.src = result.info.secure_url;
        preview.style.display = 'block';
    }
});

document.getElementById("upload_widget_opener_edit").addEventListener("click", function () {
    myWidgetEdit.open();
});

</script>


{% endblock %}
